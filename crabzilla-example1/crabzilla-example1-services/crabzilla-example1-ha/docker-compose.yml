version: '3.4'

services:

    db:
        image: mysql:5.6.34
        restart: always
        ports:
               - 3306:3306
        environment:
            MYSQL_ROOT_PASSWORD: my-secret-pwd
        volumes:
            - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d

    web:
        image: java:alpine
        restart: always
        volumes:
            - ./crabzilla-example1-ha-web/target/crabzilla-example1-ha-web-0.0.6-SNAPSHOT-fat.jar:/var/app.jar:z
            - ./crabzilla-example1-ha-web/target/classes/conf/:/var/conf
            - ./wait-for.sh:/wait-for.sh:z
        command: ["./wait-for.sh", "db:3306", "--", "java", "-jar", "/var/app.jar", "--conf", "/var/conf/config.properties"]
        ports:
            - 8080:8080
        depends_on:
            - db
            - command-handler
        environment:
            WRITE_DATABASE_URL: jdbc:mysql://db:3306/example1_write?serverTimezone=UTC&useSSL=false
            WRITE_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            WRITE_DATABASE_USER: root
            WRITE_DATABASE_PASSWORD: my-secret-pwd
            WRITE_DATABASE_POOL_MAX_SIZE: 10
            READ_DATABASE_URL: jdbc:mysql://db:3306/example1_read?serverTimezone=UTC&useSSL=false
            READ_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            READ_DATABASE_USER: root
            READ_DATABASE_PASSWORD: my-secret-pwd
            READ_DATABASE_POOL_MAX_SIZE: 10

    command-handler:
        image: java:alpine
        restart: always
        volumes:
            - ./crabzilla-example1-ha-handler/target/crabzilla-example1-ha-handler-0.0.6-SNAPSHOT-fat.jar:/var/app.jar:z
            - ./crabzilla-example1-ha-handler/target/classes/conf/:/var/conf
            - ./wait-for.sh:/wait-for.sh:z
        command: ["./wait-for.sh", "db:3306", "--", "java", "-jar", "/var/app.jar", "--conf", "/var/conf/config.properties"]
        depends_on:
            - db
        environment:
            WRITE_DATABASE_URL: jdbc:mysql://db:3306/example1_write?serverTimezone=UTC&useSSL=false
            WRITE_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            WRITE_DATABASE_USER: root
            WRITE_DATABASE_PASSWORD: my-secret-pwd
            WRITE_DATABASE_POOL_MAX_SIZE: 10
            READ_DATABASE_URL: jdbc:mysql://db:3306/example1_read?serverTimezone=UTC&useSSL=false
            READ_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            READ_DATABASE_USER: root
            READ_DATABASE_PASSWORD: my-secret-pwd
            READ_DATABASE_POOL_MAX_SIZE: 10

    events-projector:
        image: java:alpine
        restart: always
        volumes:
            - ./crabzilla-example1-ha-projector/target/crabzilla-example1-ha-projector-0.0.6-SNAPSHOT-fat.jar:/var/app.jar:z
            - ./crabzilla-example1-ha-projector/target/classes/conf/:/var/conf
            - ./wait-for.sh:/wait-for.sh:z
        command: ["./wait-for.sh", "db:3306", "--", "java", "-jar", "/var/app.jar", "--conf", "/var/conf/config.properties"]
        depends_on:
            - db
        environment:
            WRITE_DATABASE_URL: jdbc:mysql://db:3306/example1_write?serverTimezone=UTC&useSSL=false
            WRITE_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            WRITE_DATABASE_USER: root
            WRITE_DATABASE_PASSWORD: my-secret-pwd
            WRITE_DATABASE_POOL_MAX_SIZE: 10
            READ_DATABASE_URL: jdbc:mysql://db:3306/example1_read?serverTimezone=UTC&useSSL=false
            READ_DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
            READ_DATABASE_USER: root
            READ_DATABASE_PASSWORD: my-secret-pwd
            READ_DATABASE_POOL_MAX_SIZE: 10
